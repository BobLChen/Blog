---
title: 骨骼动画简介
date: 2019-08-07 07:52:40
tags:
- Vulkan
- 物理设备
- 3D
- Demo
categories:
- Vulkan
---

[项目Github地址请戳我](https://github.com/BobLChen/VulkanDemos)

## 1、骨架

骨架由一系列具有层次关系的关节(骨骼)组成，是一种树结构。可以通过平移和旋转根关节来确定整个骨架在模型空间中的位置和方向。父关节运动能影响子关节运动，但子关节运动对父关节不产生影响。因此平移、旋转、缩放父关节时，也会同时平移、旋转、缩放其所有子关节。

<!-- more -->

![0.png](0.png)

## 2、骨骼的表示

通常会将骨骼进行编号[0,N−1],编号也是关节索引。一个骨骼包含以下信息:
- 名称
- 索引
- 父骨骼索引
- BindPose(可能是逆变换，后面再说)

```c++
struct Joint
{
    std::string  name;
    int32        index;
    int32        parent;
    Matrix4x4    bindPose;
    // Matrix4x4 inverseBindPose;
};
```

## 姿态

把关节旋转、平移、缩放，就能为骨架摆出各种姿势。关节的姿势被定义为关节相对于某坐标系的位置、朝向、缩放。通常骨架存在绑定姿势、局部姿势、全局姿势。

### 绑定姿势

绑定姿势是网格绑定到骨骼之前的姿势，也就是将网格当作正常`没有蒙皮`的姿势，通常是美术绑定模型时预设的。下图左边是绑定姿势，右图是某个运动状态的姿势：

![1.png](1.png)

### 局部姿势

局部姿势是关节相对于父关节的位置、缩放、旋转状态。局部姿势存储为TQS的格式，表示相对与父关节的位置、朝向、缩放。

### 全局姿势

全局姿势是相对于局部姿势而言的，它是关节相对于模型空间的姿势（局部姿势是相对于父关节的姿势）。假设某个关节`J`坐标空间的点`q`需要转换到全局空间，那么可以通过从该关节`J`开始一直遍历到根关节，即可将`q`变换到`世界坐标系(模型空间)`中表示的坐标形式。

![2.png](2.png)

如上图所示，左边是人体骨架名称，右边是对应的标号。现在假我们将关节`rfemur`空间的点`q`变换到`世界坐标系(模型空间)`中,`rfemur`关节编号是8，我们用P8表示它的局部姿势矩阵，以此类推，那么`q`在世界坐标系中`q′`的坐标可以表示为：
```C++
q′ = P1 x P7 x P8 x q
```
对应的变换矩阵是`P1P7P8`,该变换矩阵便是关节`8`的`全局姿势矩阵`。它直接将关节`8坐标系下`的`点`变换到世界坐标系中。变换矩阵的`逆`表示`逆变换`，那么`全局姿势矩阵`的`逆矩阵`可以将`世界空间`的点变换到`关节空间中`。那么在世界坐标系中`q′`的坐标可以通过逆变换转化到关节`rfemur`空间的点`q`。
```C++
q = inverse(P1 x P7 x P8) x q′
```
